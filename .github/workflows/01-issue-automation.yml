name: 01-Issue automation

## Trigger(s)
on:
  # When issue is labelled
  issues:
    types:
      - labeled

  # When manually triggered
  workflow_dispatch:
    inputs:
      title:
        type: string
        required: true
        description: Issue title
      label:
        type: choice
        options:
          - auto-created
          - bug
          - none
        description: (optional) Issue label
        default: none
        required: false

  # When a POST request is made to https://api.github.com/repos/iveylabs/GH-eShopOnWeb/dispatches with the "event_type" of "demo-event"
  repository_dispatch:
    types: [ demo-event ]

jobs:
  # Create an issue only when manually triggered
  create-issue-manual:
    name: Create issue (manually triggered)
    if: github.event_name == 'workflow_dispatch'
    runs-on: ubuntu-latest
    permissions:
      issues: write
    steps:
      # Don't add a label to the issue
      - name: Create issue (without label)
        if: inputs.label == 'none'
        run: gh issue create --repo ${{ github.repository }} --title "${{ env.title }}" --body "Created using the CLI in a workflow"
        env:
          title: ${{ inputs.title }}
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      # Add a label to the issue
      - name: Create issue (with label)
        if: inputs.label != 'none'
        run: gh issue create --repo ${{ github.repository }} --title "${{ env.title }}" --label ${{ inputs.label }} --body "Created using the CLI in a workflow"
        env:
          title: ${{ inputs.title }}
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # Add a comment to an issue when the 'add-comment' label is added
  add-comment:
    name: Add comment
    if: github.event.label.name == 'add-comment'
    runs-on: ubuntu-latest
    permissions:
      issues: write
    steps:
    # Add a comment
    - name: Add comment
      run: gh issue comment $ISSUE --body "Oh look at you, adding labels! Very fancy... üòí"
      env:
        GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        ISSUE: ${{ github.event.issue.html_url }}

    # Add the 'i-can-do-that-too' label and add a comment
    - name: Add label
      run: |
        gh issue edit $ISSUE --add-label "i-can-do-that-too"
        gh issue comment $ISSUE --body "Would you look at that! üò± I too can add labels. Not so special now, are you? üòè"
      env:
        GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        ISSUE: ${{ github.event.issue.html_url }}

  # Create an issue only when webhook triggered
  create-issue-webhook:
    name: Create issue (webhook)
    if: github.event_name == 'repository_dispatch' && github.event.client_payload.issue == "create"
    runs-on: ubuntu-latest
    permissions:
      issues: write
    steps:
      - name: Create issue
        run: gh issue create --repo ${{ github.repository }} --title "${{ env.title }}" --body "Created using the CLI in a workflow" --assignee ${{ github.event.client_payload.assign-to }}
        env:
          title: ${{ inputs.title }}
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
